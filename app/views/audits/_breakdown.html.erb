<%= turbo_stream_from "audit_#{audit.uid}_breakdown_view_stream" %>

<%= turbo_frame_tag "audit_#{audit.uid}_breakdown" do %>
  <% if audit.pending? %>
    <div class='text-center'>
      <h4>Audit is in progress</h4>
      <%= display_loading_icon %>
    </div>
  <% elsif audit.failed? %>
    <div class='text-center'>
      <h4 class='text-center'>Audit failed:</h4>
      <h5 class='text-center'><%= audit.error_message %></h5>
    </div>
  <% else %>
    <h3 class='text-center'>Tagsafe Score</h3>
    <%= render 'partials/progress_ring', 
                score: audit.tagsafe_score, 
                change_in_score: audit.audit_to_compare_with.present? ? audit.tagsafe_score - audit.audit_to_compare_with&.tagsafe_score : nil %>

    <div class='mt-3'>
      <% audit.audit_components.each do |audit_component| %>
        <div class='mb-2'>
          <span class='fs-6'>
            <%= audit_component.friendly_name %> score: <span class='fw-bolder'><%= audit_component.formatted_score %> / 100</span>
            <% if audit.audit_to_compare_with %>
              <% change_in_score = audit_component.score - audit_component.audit_component_to_compare_with.score %>
              <% if change_in_score > 0 %>
                <i class="fa-solid fa-arrow-trend-up text-success" data-controller='tooltip' title="Up from <%= audit_component.audit_component_to_compare_with.score %> on <%= audit.audit_to_compare_with.created_at.formatted_short %>"></i>
              <% elsif change_in_score < 0 %>
                <i class="fa-solid fa-arrow-trend-down text-danger" data-controller='tooltip' title="Down from <%= audit_component.audit_component_to_compare_with.score %> on <%= audit.audit_to_compare_with.created_at.formatted_short %>"></i>
              <% end %>
            <% end %>
          </span>
          <div class='audit-component-visual-bar' data-controller='tooltip' title='The "<%= audit_component.friendly_name %>" audit scored a <%= audit_component.formatted_score %> / 100. <%= audit_component.explanation %>'>
            <div class='audit-component-visual-inner-bar <%= audit_component.score >= 90 ? 'good' : audit_component.score >= 80 ? 'warn' : 'bad' %>' style='width: <%= audit_component.score %>%'>
            </div>
            <div class='audit-component-visual-outter-bar' style='width: <%= 100 - audit_component.score %>%'>
            </div>
          </div>
        </div>
      <% end %>
      <% if audit.tag.load_type != 'defer' %>
        <div class='default-cursor mt-4 d-flex align-items-center alert alert-warning'>
          <%= HtmlHelper.WARNING_ICON %> 
          <span class='fs-6 ms-3'>
            The <%= audit.tag.try_friendly_name %> tag is a<%= audit.tag.load_type == 'async' ? 'n' : nil %> `<%= audit.tag.load_type %>` script tag.
            <% if audit.tag.load_type == 'async' %>
              While `async`` tags are a good practice, `defer` tags are recommended.
            <% else %>
              Synchronous tags negatively impact your page load. It is recommended to use `defer` tags unless there's a good reason not to.
            <% end %>
        </div>
      <% end %>
    </div>
  <% end %>
<% end %>