<div class="text-center">
  <h3>Monitor Center</h3>

  <% if current_domain.nil? %>
    <h5>You have not defined your domain(s) to monitor.</h5>
  <% else %>
    <div class="global-psi-chart-container">
      <h5>Performance Score Impact</h5>
      <label for="metric-dropdown">Select Chart Metric</label>
      <select class="selectpicker" id="metric-dropdown" data-max-options="1" data-live-search="true">
        <option value="psi" data-metric-unit="points" selected>Performance Score Impact</option>
        <% LighthouseAuditMetricType.all.each do |metric_type| %>
          <option value="<%= metric_type.key %>" data-metric-unit="<%=metric_type.result_unit%>"><%= metric_type.title %></option>
        <% end %>
      </select>
      <div id="scripts-chart-container">
        <%= 
          line_chart domain_script_subscribers_chart_path(current_domain, script_subscriber_ids: @script_subscriptions.active.still_on_site.collect(&:id)), 
            download: true, 
            title: 'Performance Score Impact Over Time',
            ytitle: 'Performance Score Impact',
            xtitle: 'Script Change',
            curve: false,
            messages: { empty: "No Audits Ran." },
            curve: false, 
            legend: "bottom", 
            code: true 
        %>
      </div>
    </div>  

    <div class="script-subscriptions">
      <% @script_subscriptions.in_groups_of(3, false).each do |group| %>
        <div class="row row-no-side-margins">
          <% group.each do |script_subscription| %>
            <div class="col-sm-12 col-md-6 col-lg-4 tag-safe-card-container">
              <div class="card tag-safe-card script-subscription <%= script_subscription.inactive? ? 'inactive' : nil %> <%= script_subscription.removed_from_site? ? 'removed-from-site' : nil %>">
                <%= link_to script_subscriber_path(script_subscription) do %>
                  <div class="col-12 logo-container">
                    <%= image_tag script_subscription.try_image_url, class: 'img-fluid script-logo' %>
                    <span data-toggle="tooltip"
                      data-placement="top"
                      title="<%= script_subscription.try_friendly_name%>">
                      <h5 class="card-title"><%= script_subscription.try_friendly_name %></h5>
                    </span>
                  </div>
                  <div class="card-body text-center col-12">
                    <% if script_subscription.removed_from_site? %>
                      <span data-toggle="tooltip"
                          data-placement="top"
                          title="The <%= script_subscription.try_friendly_name %> tag was removed from <%= current_domain.url %> on <%= script_subscription.removed_from_site_at.formatted %>.">
                        <p><i class="fas fa-exclamation-circle"></i> Removed</p>
                      </span>
                    <% elsif script_subscription.inactive? %>
                      <span data-toggle="tooltip"
                        data-placement="top"
                        title="Tag monitoring is off for <%= script_subscription.try_friendly_name %>. Visit your tag management settings to monitor.">
                        <p><i class="fas fa-exclamation-circle"></i> Inactive</p>
                      </span>
                    <% else %>
                      <p>
                        Last change was <%= script_subscription.script.content_changed_at ? time_ago_in_words(script_subscription.script.content_changed_at) : 'unknown'%> ago.
                      </p>
                      <%= render partial: 'partials/card_audit_stats', locals: {
                        script_subscriber: script_subscription,
                        audit: script_subscription.primary_audit_by_script_change(script_subscription.script.most_recent_change),
                        previous_audit: script_subscription.primary_audit_by_script_change(script_subscription.script.most_recent_change&.previous_change)
                      } %>
                    <% end %>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>
    <div class="pagination-container text-center">
      <%= paginate @script_subscriptions %>
    </div>
  <% end %>
</div>