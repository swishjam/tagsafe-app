<div class='page-title-container'>
  <div class='container-fluid'>
    <div class='row'>
      <div class='col-8'>
        <h1 class="page-title">Tag Performance</h1>
      </div>
      <div class='col-4 page-title-cta-container'>
        <%= modal_link select_tag_to_audit_tags_path, text: 'Run Audit', klass: 'page-title-cta-btn floating-btn tagsafe-purple-bg' %>
      </div>
    </div>
  </div>
</div>

<% if @tags.any? %>
  <%= turbo_frame_tag "#{current_domain.uid}_domain_tags_chart", src: charts_tags_path(tag_ids: @tags.collect(&:id), include_metric_select: true) do %>
    <div class='tagsafe-containe text-center p-5'>
      <%= display_loading_icon %>
    </div>
  <% end %>
<% else %>
  <div class='text-center p-5'>
    <h4>No tags present.</h4>
  </div>
<% end %>

<div class='tagsafe-container'>
  <table class="table table-hover col-12 text-center" style="table-layout: fixed">
    <thead>
      <tr>
        <th scope="col" style='width: 20%'>Tag</th>
        <th scope="col" style='width: 9.8%'>DOM Complete Impact</th>
        <th scope="col" style='width: 9.8%'>DOM Interactive Impact</th>
        <th scope="col" style='width: 9.8%'>First Contentful Paint Impact</th>
        <th scope="col" style='width: 9.8%'>Script Duration Impact</th>
        <th scope="col" style='width: 9.8%'>Layout Duration Impact</th>
        <th scope="col" style='width: 9.8%'>Task Duration Impact</th>
        <th scope="col" style='width: 9.8%'>Tagsafe Score</th>
        <th scope="col" style='width: 9.8%'>Audited Date</th>
        <th></th>
      </tr>
    </thead>
    <tbody>
      <% @tags.each do |tag| %>
        <tr>
          <td data-bs-toggle="tooltip" data-placement="top" title="<%= tag.try_friendly_name %>" scope="row" style='overflow: hidden; text-overflow: ellipsis; white-space: nowrap;'><%= tag.try_friendly_name %></td>
          <% most_recent_dpa = tag.audit_to_display&.preferred_delta_performance_audit %>
          <% if most_recent_dpa %>
            <td scope="row"><%= number_to_human(most_recent_dpa.dom_complete_delta, units: { unit: 'ms', thousand: 'seconds' }) %></td>
            <td scope="row"><%= number_to_human(most_recent_dpa.dom_interactive_delta, units: { unit: 'ms', thousand: 'seconds' }) %></td>
            <td scope="row"><%= number_to_human(most_recent_dpa.first_contentful_paint_delta, units: { unit: 'ms', thousand: 'seconds' }) %></td>
            <td scope="row"><%= number_to_human(most_recent_dpa.script_duration_delta, units: { unit: 'ms', thousand: 'seconds' }) %></td>
            <td scope="row"><%= number_to_human(most_recent_dpa.layout_duration_delta, units: { unit: 'ms', thousand: 'seconds' }) %></td>
            <td scope="row"><%= number_to_human(most_recent_dpa.task_duration_delta, units: { unit: 'ms', thousand: 'seconds' }) %></td>
            <td scope="row"><%= most_recent_dpa.tagsafe_score.round(2) %></td>
            <td scope="row"><%= most_recent_dpa.audit.created_at.formatted_short %></td>
          <% else %>
            <td scope="row">-</td>
            <td scope="row">-</td>
            <td scope="row">-</td>
            <td scope="row">-</td>
            <td scope="row">-</td>
            <td scope="row">-</td>
            <td scope="row">-</td>
            <td scope="row">-</td>
          <% end %>
          <td scope="row">
            <div class="dropdown dropleft show ellipsis-dropdown tagsafe-circular-btn">
              <a class="dropdown-link" data-controller='dropdown' href="#" role="button" id="dropdownMenuLink" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <i class="fas fa-ellipsis-h" style="font-size: 18px;"></i>
              </a>
              <div class="dropdown-menu" aria-labelledby="dropdownMenuLink">
                <%= link_to 'View Tag Details', tag_path(tag), class: 'dropdown-item' %> 
              </div>
            </div>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>
</div>

<%= paginate @tags %>